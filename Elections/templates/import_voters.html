{% extends "base.html" %}
{% block title %}Import Voters{% endblock %}

{% block content %}
<div class="container mt-5 text-light">

    <!-- PAGE TITLE -->
    <h2 class="fw-bold">Import Voters</h2>
    <p class="text-muted">
        Upload a CSV or Excel file to bulk-register voters for a specific election.
    </p>

    <hr>

    <!-- ============================= -->
    <!-- IMPORT FORM -->
    <!-- ============================= -->
    <div class="card bg-dark border-secondary mb-4">
        <div class="card-body">

            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="row">

                    <!-- ELECTION SELECT -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Select Election</label>
                        <select name="election" class="form-control" required>
                            <option value="">-- Select Election --</option>
                            {% for e in elections %}
                                <option value="{{ e.id }}">{{ e.title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- FILE INPUT -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-semibold">Upload CSV / Excel File</label>
                        <input type="file"
                               name="csv_file"
                               class="form-control"
                               accept=".csv,.xlsx"
                               required>
                        <small class="text-muted">
                            Accepted columns:
                            <code>full_name</code>, <code>email</code>
                        </small>
                    </div>

                </div>

                <button class="btn btn-info mt-2">
                    <i class="bi bi-upload"></i> Import Voters
                </button>
            </form>

        </div>
    </div>

    <!-- ============================= -->
    <!-- IMPORT SUMMARY -->
    <!-- ============================= -->
    {% if import_summary %}
    <div class="alert alert-success">
        <strong>Import Completed</strong><br>
        ✔ Imported: {{ import_summary.imported }} <br>
        ⚠ Skipped (duplicates): {{ import_summary.skipped }}
    </div>
    {% endif %}

    <!-- ============================= -->
    <!-- IMPORTED VOTERS -->
    <!-- ============================= -->
    {% if voters %}

        <div class="d-flex justify-content-between align-items-center mt-4 mb-2">
            <h4 class="mb-0">Imported Voters</h4>

            <!-- DELETE ALL BUTTON -->
            <a href="{% url 'elections:delete_all_voters' voters.0.election.id %}"
               class="btn btn-danger"
               onclick="return confirm('Delete ALL voters for this election?');">
                <i class="bi bi-trash"></i> Delete All Imported Voters
            </a>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Election</th>
                        <th>Status</th>
                        <th>Date Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for voter in voters %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ voter.full_name }}</td>
                        <td>{{ voter.email }}</td>
                        <td>{{ voter.election.title }}</td>

                        <td>
                            {% if voter.has_voted %}
                                <span class="badge bg-success">Voted</span>
                            {% else %}
                                <span class="badge bg-warning text-dark">Not Voted</span>
                            {% endif %}
                        </td>

                        <td>{{ voter.created_at|date:"M d, Y H:i" }}</td>

                        <!-- DELETE SINGLE VOTER -->
                        <td>
                            {% if not voter.has_voted %}
                                <a href="{% url 'elections:delete_voter' voter.id %}"
                                   class="btn btn-sm btn-danger"
                                   onclick="return confirm('Delete this voter?');">
                                    <i class="bi bi-trash"></i>
                                </a>
                            {% else %}
                                <span class="text-muted">Locked</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>
        </div>

    {% else %}
        <div class="alert alert-info mt-4">
            No voters have been imported yet.
        </div>
    {% endif %}

</div>
{% endblock %}
